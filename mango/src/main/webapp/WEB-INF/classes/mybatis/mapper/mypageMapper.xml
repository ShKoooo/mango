<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mypage">
	<select id="getMannerProfile" parameterType="String" resultType="com.sp.mango.mypage.MannerProfile">
		SELECT userId, mannerStar, productStar, minusDeg FROM mannerProfile
		WHERE userId = #{userId}
	</select>
	<insert id="insertMannerProfile" parameterType="String">
		INSERT INTO mannerProfile (userId, mannerStar, productStar, minusDeg)
		VALUES (#{userId}, 0,0,0)
	</insert>
	<select id="listAddr" parameterType="String" resultType="com.sp.mango.member.MemberAddr">
		SELECT maNum, a.area1, a.area2, a.area3
		FROM memberAddr m
		JOIN area a ON m.areaNum = a.areaNum
		WHERE userId = #{userId}
	</select>
	<select id="readBusiness" parameterType="String" resultType="com.sp.mango.member.Business">
		SELECT userId, busNickName, busTel, busEmail, membershipNum, busImgSaveFileName, busImgOrigFileName,
			b.areaNum, busAddr1, busAddr2, busZip, bpLat, bpLon, a.area1, a.area2, a.area3
		FROM businessProfile b
		JOIN area a ON a.areaNum = b.areaNum
		WHERE userId = #{userId}
	</select>
	
	<select id="listPickedUser" parameterType="String" resultType="com.sp.mango.mypage.PickedUser">
		SELECT pickedNum, target_id, TO_CHAR(regDate,'YYYY-MM-DD') regDate
		FROM pickedUser
		WHERE userId = #{userId}
	</select>
	
	<select id="listBlockedUser" parameterType="String" resultType="com.sp.mango.mypage.PickedUser">
		SELECT blockNum, target_id, TO_CHAR(regDate,'YYYY-MM-DD') regDate
		FROM blockedUser
		WHERE userId = #{userId}
	</select>
	
	<select id="listKeyword" parameterType="String" resultType="com.sp.mango.mypage.PickedUser">
		SELECT keywordNum, keyword, TO_CHAR(regDate,'YYYY-MM-DD') regDate
		FROM keyword
		WHERE userId = #{userId}
	</select>
	
	<select id="myPickCount" parameterType="map" resultType="Integer">
		SELECT NVL(COUNT(*),0)
		FROM pickedUser p
		JOIN member m ON p.target_id = m.userId
		<where>
			p.userId = #{userId}
			<if test="keyword != null and keyword != '' ">
				AND
				INSTR(m.userNickName, #{keyword}) > 0
			</if>
		</where>
	</select>
	
	<select id="listMyPickedUser" parameterType="map" resultType="com.sp.mango.mypage.PickedUser">
		SELECT * FROM (
			SELECT ROWNUM rnum, tb.* FROM (	
				SELECT pickedNum, p.userId, p.target_id, m.userNickName, p.regDate
				FROM pickedUser p
				JOIN member m ON p.target_id = m.userId
				<where>
					p.userId = #{userId}
					<if test="keyword != null and keyword != '' ">
						AND
						INSTR(m.userNickName, #{keyword}) > 0
					</if>
				</where>
				ORDER BY p.regDate DESC
			) tb WHERE ROWNUM &lt;= #{end}
		) WHERE rnum &gt;= #{start}
	</select>
	
	<select id="readUserIdByNickName" parameterType="String" resultType="String">
		SELECT userId
		FROM member
		WHERE userNickName = #{userNickName}
	</select>
	
	<insert id="insertPickedUser" parameterType="map">
		INSERT INTO pickedUser
		(pickedNum, userId, target_id, regDate)
		VALUES
		(pickedUser_seq.NEXTVAL, #{userId}, #{target_id}, SYSDATE)
	</insert>
	
	<delete id="deleteMySelection" parameterType="map">
		DELETE FROM ${tableName} WHERE ${seqName} = #{seqNum}
	</delete>
	
	<select id="myBlockCount" parameterType="map" resultType="Integer">
		SELECT NVL(COUNT(*),0)
		FROM blockedUser p
		JOIN member m ON p.target_id = m.userId
		<where>
			p.userId = #{userId}
			<if test="keyword != null and keyword != '' ">
				AND
				INSTR(m.userNickName, #{keyword}) > 0
			</if>
		</where>
	</select>
	
	<select id="listMyBlockedUser" parameterType="map" resultType="com.sp.mango.mypage.BlockedUser">
		SELECT * FROM (
			SELECT ROWNUM rnum, tb.* FROM (	
				SELECT blockNum, p.userId, p.target_id, m.userNickName, p.regDate
				FROM blockedUser p
				JOIN member m ON p.target_id = m.userId
				<where>
					p.userId = #{userId}
					<if test="keyword != null and keyword != '' ">
						AND
						INSTR(m.userNickName, #{keyword}) > 0
					</if>
				</where>
				ORDER BY p.regDate DESC	
			) tb WHERE ROWNUM &lt;= #{end}
		) WHERE rnum &gt;= #{start}
	</select>
	
	<insert id="insertBlockedUser" parameterType="map">
		INSERT INTO blockedUser
		(blockNum, userId, target_id, regDate)
		VALUES
		(blockedUser_seq.NEXTVAL, #{userId}, #{target_id}, SYSDATE)
	</insert>
	
	<select id="myKeywordCount" parameterType="map" resultType="Integer">
		SELECT NVL(COUNT(*),0)
		FROM keyword
		<where>
			userId = #{userId}
			<if test="keyword != null and keyword != '' ">
				AND
				INSTR(keyword, #{keyword}) > 0
			</if>
		</where>
	</select>
	
	<select id="listMyKeyword" parameterType="map" resultType="com.sp.mango.mypage.Keyword">
		SELECT * FROM (
			SELECT ROWNUM rnum, tb.* FROM (	
				SELECT keywordNum, userId, keyword, regDate
				FROM keyword
				<where>
					userId = #{userId}
					<if test="keyword != null and keyword != '' ">
						AND
						INSTR(keyword, #{keyword}) > 0
					</if>
				</where>
				ORDER BY regDate DESC
			) tb WHERE ROWNUM &lt;= #{end}
		) WHERE rnum &gt;= #{start}
	</select>
	
	<insert id="insertKeyword" parameterType="map">
		INSERT INTO keyword
		(keywordNum, userId, keyword, regDate)
		VALUES
		(keyword_seq.NEXTVAL, #{userId}, #{keyword}, SYSDATE)
	</insert>
</mapper>